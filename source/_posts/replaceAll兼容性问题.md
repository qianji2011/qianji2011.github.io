---
title: replaceAll兼容性问题
date: 2022-02-17 18:00:04
tags: 微信小程序
categories: 技术
---
汗颜呐，一直以为replace和replaceAll没有兼容性问题。然而，还是太年轻了。
### 问题产生的场景
- 场景一
开发微信小程序的时候，通常需要对url中携带的参数进行编码和解码。如果使用encodeURIComponent方法对包含%的参数进行编码后,再直接使用decodeURIComponent方法进行解码，这个时候有部分手机报错了，解析参数异常。这个时候需要将%替换成%25。字符串替换嘛，立马想到了使用replaceAll。上了体验版，并在不同的测试机测试没问题之后就发布到正式环境。发现问题还是需要广大人民群众的力量。不久，就有用户反馈问题，根据截图，一度怀疑是decodeURIComponent又问题
- 场景二
同样是开发微信小程序，需要接口返回数据做处理，将字符串中的-字符全部转换成/，也是习惯吧，当即使用了replaceAll。最后还是实际出真知，又被告知部分用户数据展示不正确。

### 问题产生的原因
遇到上述场景一的问题的时候，并没有怀疑是replaceAll有兼容性问题，只是换成调用接口获取页面参数，曲线救国，并没有根本解决问题。之后，遇到场景二，才慢慢排除，并联想到两个场景的共同点是使用了replaceAll方法。这个时候才恍然大悟，哦，原来是这个地方有问题！

### 解决办法
以场景一为例，产生问题的代码如下
``` bash
// url原始路径
const urlAfter = url.replaceAll('%','%25')
```
将replaceAll替换为replace，并使用正则匹配%
``` bash
// url原始路径
const urlAfter = url.replace(/%/g,'%25')
```
这样就解决了